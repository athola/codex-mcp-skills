name: Integration Tests

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/integration-tests.yml'
  schedule:
    # Run integration tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of integration tests to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - gateway-flow
          - tls-validation
          - metrics-collection
          - error-recovery

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: "-D warnings"
  RUSTDOCFLAGS: "-D warnings"

jobs:
  integration-test-filter:
    runs-on: ubuntu-latest
    outputs:
      gateway-flow: ${{ steps.filter.outputs.gateway-flow }}
      tls-validation: ${{ steps.filter.outputs.tls-validation }}
      metrics-collection: ${{ steps.filter.outputs.metrics-collection }}
      error-recovery: ${{ steps.filter.outputs.error-recovery }}
      all: ${{ steps.filter.outputs.all }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            gateway-flow:
              - 'crates/gateway/src/**'
              - 'crates/gateway/tests/gateway_flow_integration.rs'
              - 'crates/gateway/tests/common/**'
              - 'crates/server/src/**'
              - 'crates/discovery/src/**'
            tls-validation:
              - 'crates/gateway/src/tls.rs'
              - 'crates/gateway/tests/tls_validation_integration.rs'
              - 'crates/gateway/tests/common/**'
            metrics-collection:
              - 'crates/gateway/src/metrics.rs'
              - 'crates/gateway/tests/metrics_collection_integration.rs'
              - 'crates/gateway/tests/common/**'
            error-recovery:
              - 'crates/gateway/tests/error_recovery_integration.rs'
              - 'crates/gateway/tests/common/**'
            all:
              - 'crates/gateway/**'
              - '.github/workflows/integration-tests.yml'

  prepare-integration-test-environment:
    runs-on: ubuntu-latest
    needs: integration-test-filter
    if: needs.integration-test-filter.outputs.all == 'true' || needs.integration-test-filter.outputs.gateway-flow == 'true' || needs.integration-test-filter.outputs.tls-validation == 'true' || needs.integration-test-filter.outputs.metrics-collection == 'true' || needs.integration-test-filter.outputs.error-recovery == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache cargo registry and index
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-integration-test-target-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-integration-test-target-
            ${{ runner.os }}-test-target-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libssl-dev \
            build-essential \
            openssl

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Build all workspace members
        run: cargo build --workspace --all-targets

      - name: Build test binaries
        run: |
          cargo build -p skrills --bin skrills
          cargo build --bins

  gateway-flow-integration-tests:
    runs-on: ubuntu-latest
    needs: [integration-test-filter, prepare-integration-test-environment]
    if: (needs.integration-test-filter.outputs.all == 'true' || needs.integration-test-filter.outputs.gateway-flow == 'true' || github.event.inputs.test_type == 'gateway-flow' || github.event.inputs.test_type == 'all') && (needs.prepare-integration-test-environment.result == 'success')
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo registry and index
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-integration-test-target-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-integration-test-target-
            ${{ runner.os }}-test-target-

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Run gateway flow integration tests
        run: |
          echo "Running gateway flow integration tests..."
          cargo test -p skrills-gateway --test gateway_flow_integration -- --nocapture
          echo "Gateway flow integration tests completed!"

      - name: Upload gateway flow test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gateway-flow-test-results
          path: |
            target/nextest/dev/
            target/legacy-json-tests/
          retention-days: 7

  tls-validation-integration-tests:
    runs-on: ubuntu-latest
    needs: [integration-test-filter, prepare-integration-test-environment]
    if: (needs.integration-test-filter.outputs.all == 'true' || needs.integration-test-filter.outputs.tls-validation == 'true' || github.event.inputs.test_type == 'tls-validation' || github.event.inputs.test_type == 'all') && (needs.prepare-integration-test-environment.result == 'success')
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo registry and index
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-integration-test-target-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-integration-test-target-
            ${{ runner.os }}-test-target-

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Install OpenSSL development headers
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Run TLS validation integration tests
        run: |
          echo "Running TLS validation integration tests..."
          cargo test -p skrills-gateway --test tls_validation_integration -- --nocapture
          echo "TLS validation integration tests completed!"

      - name: Upload TLS test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tls-validation-test-results
          path: |
            target/nextest/dev/
            target/legacy-json-tests/
          retention-days: 7

  metrics-collection-integration-tests:
    runs-on: ubuntu-latest
    needs: [integration-test-filter, prepare-integration-test-environment]
    if: (needs.integration-test-filter.outputs.all == 'true' || needs.integration-test-filter.outputs.metrics-collection == 'true' || github.event.inputs.test_type == 'metrics-collection' || github.event.inputs.test_type == 'all') && (needs.prepare-integration-test-environment.result == 'success')
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo registry and index
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-integration-test-target-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-integration-test-target-
            ${{ runner.os }}-test-target-

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Run metrics collection integration tests
        run: |
          echo "Running metrics collection integration tests..."
          cargo test -p skrills-gateway --test metrics_collection_integration -- --nocapture
          echo "Metrics collection integration tests completed!"

      - name: Upload metrics test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: metrics-collection-test-results
          path: |
            target/nextest/dev/
            target/legacy-json-tests/
          retention-days: 7

  error-recovery-integration-tests:
    runs-on: ubuntu-latest
    needs: [integration-test-filter, prepare-integration-test-environment]
    if: (needs.integration-test-filter.outputs.all == 'true' || needs.integration-test-filter.outputs.error-recovery == 'true' || github.event.inputs.test_type == 'error-recovery' || github.event.inputs.test_type == 'all') && (needs.prepare-integration-test-environment.result == 'success')
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo registry and index
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
            ${{ runner.os }}-cargo-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-integration-test-target-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-integration-test-target-
            ${{ runner.os }}-test-target-

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Run error recovery integration tests
        run: |
          echo "Running error recovery integration tests..."
          cargo test -p skrills-gateway --test error_recovery_integration -- --nocapture
          echo "Error recovery integration tests completed!"

      - name: Upload error recovery test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: error-recovery-test-results
          path: |
            target/nextest/dev/
            target/legacy-json-tests/
          retention-days: 7

  integration-test-summary:
    runs-on: ubuntu-latest
    needs: [gateway-flow-integration-tests, tls-validation-integration-tests, metrics-collection-integration-tests, error-recovery-integration-tests]
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        if: always()
        with:
          path: test-results/
          pattern: "*-test-results"

      - name: Create integration test summary
        if: always()
        run: |
          echo "# Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Gateway Flow Tests
          if [[ "${{ needs.gateway-flow-integration-tests.result }}" == "success" ]]; then
            echo "[PASSED] Gateway Flow Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.gateway-flow-integration-tests.result }}" == "failure" ]]; then
            echo "[FAILED] Gateway Flow Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          else
            echo "[SKIPPED] Gateway Flow Tests: SKIPPED" >> $GITHUB_STEP_SUMMARY
          fi

          # TLS Validation Tests
          if [[ "${{ needs.tls-validation-integration-tests.result }}" == "success" ]]; then
            echo "[PASSED] TLS Validation Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.tls-validation-integration-tests.result }}" == "failure" ]]; then
            echo "[FAILED] TLS Validation Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          else
            echo "[SKIPPED] TLS Validation Tests: SKIPPED" >> $GITHUB_STEP_SUMMARY
          fi

          # Metrics Collection Tests
          if [[ "${{ needs.metrics-collection-integration-tests.result }}" == "success" ]]; then
            echo "[PASSED] Metrics Collection Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.metrics-collection-integration-tests.result }}" == "failure" ]]; then
            echo "[FAILED] Metrics Collection Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          else
            echo "[SKIPPED] Metrics Collection Tests: SKIPPED" >> $GITHUB_STEP_SUMMARY
          fi

          # Error Recovery Tests
          if [[ "${{ needs.error-recovery-integration-tests.result }}" == "success" ]]; then
            echo "[PASSED] Error Recovery Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.error-recovery-integration-tests.result }}" == "failure" ]]; then
            echo "[FAILED] Error Recovery Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          else
            echo "[SKIPPED] Error Recovery Tests: SKIPPED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Coverage Areas Tested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Full autoload → gateway → Codex flow" >> $GITHUB_STEP_SUMMARY
          echo "- TLS certificate validation" >> $GITHUB_STEP_SUMMARY
          echo "- Metrics collection and monitoring" >> $GITHUB_STEP_SUMMARY
          echo "- Error recovery scenarios" >> $GITHUB_STEP_SUMMARY
          echo "- Concurrency and performance" >> $GITHUB_STEP_SUMMARY
          echo "- Network partition handling" >> $GITHUB_STEP_SUMMARY
          echo "- Memory pressure recovery" >> $GITHUB_STEP_SUMMARY

  integration-test-report:
    runs-on: ubuntu-latest
    needs: [integration-test-filter]
    if: failure() && (needs.integration-test-filter.outputs.all == 'true' || needs.integration-test-filter.outputs.gateway-flow == 'true' || needs.integration-test-filter.outputs.tls-validation == 'true' || needs.integration-test-filter.outputs.metrics-collection == 'true' || needs.integration-test-filter.outputs.error-recovery == 'true')
    steps:
      - name: Comment on PR with integration test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `## Integration Tests Failed

              The integration tests have failed. Please review the logs and fix any issues before merging.

              ### Areas Tested
              - Full autoload -> gateway -> Codex flow
              - TLS certificate validation
              - Metrics collection and monitoring
              - Error recovery scenarios

              ### Next Steps
              1. Check the **Actions** tab for detailed failure logs
              2. Review integration test coverage
              3. Fix any failing tests
              4. Ensure new functionality has proper test coverage

              ### Test Files
              - \`crates/gateway/tests/gateway_flow_integration.rs\`
              - \`crates/gateway/tests/tls_validation_integration.rs\`
              - \`crates/gateway/tests/metrics_collection_integration.rs\`
              - \`crates/gateway/tests/error_recovery_integration.rs\`

              **Remember**: Integration tests validate the complete end-to-end functionality of the skrills middleware server.`
            });

  integration-test-coverage:
    runs-on: ubuntu-latest
    needs: integration-test-filter
    if: (needs.integration-test-filter.outputs.all == 'true' || github.event.inputs.test_type == 'all') && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --locked

      - name: Generate integration test coverage
        run: |
          # Run integration tests with coverage
          cargo llvm-cov --lib --bin skrills --workspace --lcov --test-features --tests -- \
            -p skrills-gateway \
            gateway_flow_integration \
            tls_validation_integration \
            metrics_collection_integration \
            error_recovery_integration \
            -- --nocapture

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          flags: integration-tests
          name: integration-tests-coverage
          fail_ci_if_error: false